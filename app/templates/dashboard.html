<!-- templates/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garmin Training Load Dashboard</title>
    
    <!-- Favicon - Monkey Mascot -->
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('serve_landing_static', filename='images/monkey_700.jpg') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('serve_landing_static', filename='images/monkey_700.jpg') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('serve_landing_static', filename='images/monkey_700.jpg') }}">
    <link rel="shortcut icon" href="{{ url_for('serve_landing_static', filename='images/monkey_700.jpg') }}">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DP521017ER"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-DP521017ER');
    </script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f6f9;
            margin: 0;
            padding: 0;
        }
        .navbar {
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        .navbar-links a {
            color: white;
            text-decoration: none;
            margin-left: 1rem;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        .dashboard-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .dashboard-card h2 {
            color: #2c3e50;
            margin-top: 0;
        }
        .loading-message {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>Garmin Training Load Dashboard</h1>
        <div class="navbar-links">
            <a href="{{ url_for('settings') }}">Settings</a>
            <a href="{{ url_for('logout_page') }}">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="dashboard-card">
            <h2>Training Data</h2>
            <div id="training-data">
                <div class="loading-message">Loading your training data...</div>
            </div>
        </div>

        <div class="dashboard-card">
            <h2>Training Stats</h2>
            <div id="training-stats">
                <div class="loading-message">Loading statistics...</div>
            </div>
        </div>
    </div>

    <script>
        // Fetch training data
        fetch('/api/training-data')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('training-data');
                container.innerHTML = '';

                if (data.data && data.data.length > 0) {
                    // Show the most recent 10 activities
                    const recentActivities = data.data.slice(-10).reverse();

                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';

                    // Create table header
                    const thead = document.createElement('thead');
                    thead.innerHTML = `
                        <tr>
                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Date</th>
                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Activity</th>
                            <th style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">Distance (mi)</th>
                            <th style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">Elevation (ft)</th>
                            <th style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">TRIMP</th>
                        </tr>
                    `;
                    table.appendChild(thead);

                    // Create table body
                    const tbody = document.createElement('tbody');
                    recentActivities.forEach(activity => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">${activity.date}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">${activity.name}</td>
                            <td style="text-align: right; padding: 8px; border-bottom: 1px solid #eee;">${Number(activity.distance_miles).toFixed(2)}</td>
                            <td style="text-align: right; padding: 8px; border-bottom: 1px solid #eee;">${Number(activity.elevation_gain_feet).toFixed(0)}</td>
                            <td style="text-align: right; padding: 8px; border-bottom: 1px solid #eee;">${Number(activity.trimp).toFixed(1)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    table.appendChild(tbody);

                    container.appendChild(table);
                } else {
                    container.innerHTML = '<p>No training data available.</p>';
                }
            })
            .catch(error => {
                console.error('Error fetching training data:', error);
                document.getElementById('training-data').innerHTML = '<p>Error loading training data. Please try again later.</p>';
            });

        // Fetch training stats
        fetch('/api/stats')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('training-stats');
                container.innerHTML = '';

                if (data) {
                    const statsHtml = `
                        <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                            <div style="flex: 1; min-width: 200px;">
                                <h3>Activity Summary</h3>
                                <p>Total Activities: ${data.totalActivities}</p>
                                <p>Last Activity: ${data.lastActivity}</p>
                                <p>Days Since Rest: ${data.daysSinceRest}</p>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <h3>Training Metrics</h3>
                                <p>External ACWR: ${Number(data.latestMetrics.externalAcwr).toFixed(2)}</p>
                                <p>Internal ACWR: ${Number(data.latestMetrics.internalAcwr).toFixed(2)}</p>
                                <p>7-Day Avg Load: ${Number(data.latestMetrics.sevenDayAvgLoad).toFixed(2)} miles</p>
                                <p>7-Day Avg TRIMP: ${Number(data.latestMetrics.sevenDayAvgTrimp).toFixed(2)}</p>
                            </div>
                        </div>
                    `;
                    container.innerHTML = statsHtml;
                } else {
                    container.innerHTML = '<p>No stats available.</p>';
                }
            })
            .catch(error => {
                console.error('Error fetching stats:', error);
                document.getElementById('training-stats').innerHTML = '<p>Error loading statistics. Please try again later.</p>';
            });
    </script>
</body>
</html>