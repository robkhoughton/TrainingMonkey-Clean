# TrainingMonkey Project Rules for Cursor

## üóÑÔ∏è Database Standards (CRITICAL)
- **PostgreSQL ONLY**: Use `%s` placeholders (NOT `?`), `SERIAL PRIMARY KEY` (NOT `AUTOINCREMENT`), `NOW()` (NOT `CURRENT_TIMESTAMP`)
- **Schema Changes**: Assistant can run migrations using `app/run_migration.py`, direct SQL via `db_utils`, or SQL Editor with direct connection. Never modify schema in application code.
- **Date Operations**: Use `datetime.now().date()` for date-only operations, `'YYYY-MM-DD'` format for APIs
- **Connection**: DATABASE_URL loaded from `.env` file via `app/db_credentials_loader.py` (secure, not in version control)
- **Direct Database Access**: Assistant can execute database operations using existing `db_utils` module, migration scripts, or direct SQL execution via Python scripts with credentials from `.env` file
- **SQL Editor Execution**: Assistant has permission to execute SQL files directly using database connection. For SQL files with connection strings, use credentials from `.env` file via `db_credentials_loader` for secure execution

## üîê Database Access Methods (for AI Assistant)
1. **Schema Migrations**: Create migration script in `app/` using `db_credentials_loader` and `db_utils`, or execute SQL files directly via Python scripts
2. **Query Execution**: Use `db_utils.execute_query()` with parameterized queries
3. **Data Inspection**: Use `db_utils` for read operations to verify state
4. **Credential Loading**: Always use `from db_credentials_loader import set_database_url` for secure access from `.env` file
5. **Direct SQL Execution**: Can execute SQL files using Python scripts that connect directly to database using credentials from `.env` file
6. **Never Hardcode**: Never put DATABASE_URL or credentials in code files - always load from `.env` via `db_credentials_loader`

## üîß Code Quality Standards
- **Public APIs**: Use intended public methods, avoid private method calls
- **Error Handling**: Provide meaningful error messages, fail gracefully
- **SQL Injection**: Always use parameterized queries with `%s` placeholders
- **Transactions**: Use explicit commits and context managers for database connections

## üöÄ Development Workflow
- **Root Cause Analysis**: Check database state before making assumptions
- **End-to-End Testing**: Test complete user flows, not just components
- **Validation**: Run `validate_sql_syntax.py` before commits
- **Clean Code**: Remove debugging artifacts, use proper validation
- **Deployment**: User handles all deployments. Assistant prepares code changes but NEVER runs deployment commands

## üê≥ Dockerfile Requirements (CRITICAL FOR DEPLOYMENT)
- **Explicit File Copy**: `app/Dockerfile.strava` uses explicit `COPY` commands for each Python file (security practice)
- **New Modules Must Be Added**: When creating new `.py` files in `app/`, ALWAYS add corresponding `COPY` line to Dockerfile
- **Deployment Failure Pattern**: If deployment succeeds but gets `ModuleNotFoundError`, the module is missing from Dockerfile
- **Location**: Add new COPY commands in the "Core modules" section (lines 31-47) or create new section
- **Example**: `COPY my_new_module.py .`
- **Testing**: After adding new Python files, search Dockerfile for the filename to verify it's included

## üé® Frontend Build & Deployment Process
- **Project Structure**: React app in `frontend/` directory, Flask backend in `app/` directory
- **Build Command**: `npm run build` from within `frontend/` directory (creates optimized production build)
- **Build Output**: `frontend/build/` directory (includes index.html, static assets, etc.)

### File Copy Destinations (after build):
1. **All build files**: `frontend/build/*` ‚Üí `app/build/`
2. **Static assets**: `frontend/build/static/*` ‚Üí `app/static/`
3. **Runner image**: `frontend/build/training-monkey-runner.webp` ‚Üí `app/static/training-monkey-runner.webp`

### Build and Copy Commands (from project root):
```cmd
cd frontend
npm run build
cd..
del /Q app\static\js\main.*.js
del /Q app\static\js\main.*.LICENSE.txt
del /Q app\static\css\main.*.css
del /Q app\build\static\js\main.*.js
del /Q app\build\static\js\main.*.LICENSE.txt
del /Q app\build\static\css\main.*.css
xcopy frontend\build\* app\build\ /E /Y
xcopy frontend\build\static\* app\static\ /E /Y
copy frontend\build\training-monkey-runner.webp app\static\training-monkey-runner.webp
```

### Notes:
- Use the exact command sequence above (tested and working)
- Must be at project root before starting
- Cleanup removes old versioned files before copying new build
- Build creates versioned JS files (e.g., `main.34e5b039.js`) - index.html auto-references correct version
- After frontend changes, ALWAYS rebuild and copy before testing/deployment
- Deployment script: `app/deploy_strava_simple.bat` (user runs this, not assistant)
- Reference: `scripts/Deployment_script.txt` contains the authoritative deployment process

## üìã Timezone & Date Standards
- **Storage**: UTC timestamps in database
- **Application**: Use `get_app_current_date()` for consistent date handling
- **APIs**: Return dates in `'YYYY-MM-DD'` format
- **Debugging**: Use `log_timezone_debug()` for timezone issues

## üìä Performance Monitoring Standards (CRITICAL)
- **Two Hook System**: `usePagePerformanceMonitoring()` (page-level) + `useComponentPerformanceMonitoring()` (component-level)
- **Page Hook**: Auto-tracks Core Web Vitals (TTFB, FCP, LCP) - **NO return value** - call once per component
- **Component Hook**: Returns `{ trackFetchStart, trackFetchEnd, reportMetrics }` - use for manual tracking
- **Pattern for Data Pages**: Use BOTH hooks (see Dashboard, Activities, Journal, Coach)
- **Pattern for Simple Pages**: Use only page hook (see Settings)
- **Hook Dependencies**: Always include `perfMonitor` in `useCallback`/`useEffect` dependency arrays
- **Reference**: See `PERFMONITOR_PATTERN_FIX_SUMMARY.md` for complete examples and common mistakes

## ‚ùå Common Mistakes to Avoid
- Using SQLite syntax (`?`, `AUTOINCREMENT`, `CURRENT_TIMESTAMP`)
- Calling private methods from outside their class
- Making schema changes in application code (use migration scripts instead)
- Using `datetime.now()` for date-only operations
- Inconsistent date formats in API responses
- Hardcoding DATABASE_URL or credentials in any file
- Running database operations without loading credentials via `db_credentials_loader`
- **Using return value of `usePagePerformanceMonitoring()`** (returns void, not object)
- **Forgetting `perfMonitor` in hook dependency arrays** (causes stale closures)
- **Using only page hook when component metrics needed** (can't call `reportMetrics()`)
- **Creating new `.py` files without adding them to `Dockerfile.strava`** (causes ModuleNotFoundError in production)

## üéØ Success Criteria
- All SQL queries use PostgreSQL syntax
- All date operations use proper date objects
- All APIs return consistent formats
- All schema changes via migration scripts (assistant can run these)
- Clean error handling and logging
- Database credentials loaded securely from .env file

## üìä Database Operation Examples

### ‚úÖ Correct: Schema Migration (Method 1 - Using db_utils)
```python
# In app/my_migration.py
from db_credentials_loader import set_database_url
import db_utils

set_database_url()  # Load from .env
db_utils.execute_query("ALTER TABLE activities ADD COLUMN new_field TEXT")
```

### ‚úÖ Correct: Schema Migration (Method 2 - Direct SQL Execution)
```python
# In app/my_migration.py
from db_credentials_loader import set_database_url
import psycopg2
import os

set_database_url()  # Load from .env
DATABASE_URL = os.environ.get('DATABASE_URL')
# Parse and connect directly to execute SQL from files
conn = psycopg2.connect(DATABASE_URL)
cursor = conn.cursor()
cursor.execute("ALTER TABLE activities ADD COLUMN new_field TEXT")
conn.commit()
```

### ‚úÖ Correct: Data Query
```python
from db_credentials_loader import set_database_url
import db_utils

set_database_url()
results = db_utils.execute_query(
    "SELECT * FROM activities WHERE user_id = %s", 
    (user_id,), 
    fetch=True
)
```

### ‚ùå Wrong: Hardcoded Credentials
```python
# NEVER DO THIS
os.environ['DATABASE_URL'] = 'postgresql://user:pass@host/db'
```

## üìä Performance Monitoring Examples

### ‚úÖ Correct: Data-Driven Page (Dashboard, Activities, Journal, Coach)
```typescript
import { usePagePerformanceMonitoring, useComponentPerformanceMonitoring } from './usePerformanceMonitoring';

const MyPage: React.FC = () => {
  // Page-level metrics (auto-tracks Web Vitals, no return value)
  usePagePerformanceMonitoring('my-page');
  
  // Component-level metrics (returns object with methods)
  const perfMonitor = useComponentPerformanceMonitoring('MyPageComponent');
  
  useEffect(() => {
    const fetchData = async () => {
      perfMonitor.trackFetchStart();
      const data = await fetch('/api/data');
      perfMonitor.trackFetchEnd();
      
      perfMonitor.reportMetrics(data.length);  // Manual reporting
    };
    fetchData();
  }, [perfMonitor]);  // Include perfMonitor in deps!
};
```

### ‚úÖ Correct: Simple Page (Settings)
```typescript
import { usePagePerformanceMonitoring } from './usePerformanceMonitoring';

const SimplePage: React.FC = () => {
  usePagePerformanceMonitoring('simple-page');  // Page metrics only
  return <div>Content</div>;
};
```

### ‚ùå Wrong: Trying to Use Return Value of Page Hook
```typescript
// NEVER DO THIS - usePagePerformanceMonitoring returns void!
const perfMonitor = usePagePerformanceMonitoring('page');
perfMonitor.reportMetrics();  // ERROR: Cannot read properties of undefined
```

## üê≥ Dockerfile Deployment Example

### ‚úÖ Correct: Adding New Python Module
```dockerfile
# When creating app/my_new_feature.py, add to Dockerfile.strava:

# Copy application code - Core modules
COPY strava_app.py .
COPY my_new_feature.py .  # <-- ADD THIS LINE
COPY other_existing_file.py .
```

### ‚ùå Wrong: Forgetting Dockerfile Update
```python
# Created app/coach_recommendations.py
# Committed to git
# Deployed...
# Result: ModuleNotFoundError: No module named 'coach_recommendations'
# WHY: File not in Dockerfile.strava COPY list
```

**Checklist When Creating New Python Files**:
1. Create the `.py` file in `app/`
2. Test locally
3. Add `COPY new_file.py .` to `app/Dockerfile.strava`
4. Commit BOTH the new file AND Dockerfile changes
5. Deploy